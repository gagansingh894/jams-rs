FROM --platform=linux/amd64 ubuntu:22.04
LABEL authors="gagandeepsingh"

# Install necessary dependencies
RUN apt-get update && \
    apt-get install -y \
        clang \
        curl \
        build-essential \
        unzip \
        wget \
        && \
    rm -rf /var/lib/apt/lists/*

# Install Rust 1.78 using rustup
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain 1.78.0

# Ensure the Rust binaries are in the PATH
ENV PATH=/root/.cargo/bin:$PATH

# Install Bazel 3.7.2
RUN apt-get update && \
    apt-get install -y \
        wget \
        && \
    wget -qO /tmp/bazel-installer.sh https://github.com/bazelbuild/bazel/releases/download/3.7.2/bazel-3.7.2-installer-linux-x86_64.sh && \
    chmod +x /tmp/bazel-installer.sh && \
    /tmp/bazel-installer.sh && \
    rm /tmp/bazel-installer.sh && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*
# Confirm Bazel installation
RUN bazel --version

# Print Clang version
RUN clang --version

# Download the LightGBM shared library (.so file) from GitHub releases
RUN wget -O /usr/local/lib/lib_lightgbm.so https://github.com/microsoft/LightGBM/releases/download/v4.2.0/lib_lightgbm.so

# Download the Catboost shared library (.so file) from GitHub releases
RUN wget -O /usr/local/lib/libcatboostmodel.so https://github.com/catboost/catboost/releases/download/v1.2.3/libcatboostmodel.so

# Download libtorch
RUN wget -O /tmp/libtorch.zip https://download.pytorch.org/libtorch/cpu/libtorch-cxx11-abi-shared-with-deps-2.2.0%2Bcpu.zip && \
    unzip /tmp/libtorch.zip -d /usr/local && \
    rm /tmp/libtorch.zip

# Set the environment variable to include the directory where the shared library is located
ENV LD_LIBRARY_PATH=/usr/local/lib
ENV LIGHTGBM_LIB_DIR=/usr/local/lib
ENV LIBTORCH=/usr/local/libtorch

# Set entry point to bash
ENTRYPOINT ["/bin/bash"]