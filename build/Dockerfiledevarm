FROM --platform=linux/arm64 rust:1.78
LABEL authors="gagandeepsingh"

# Install necessary dependencies
RUN apt-get update && \
    apt-get install -y \
        clang \
        curl \
        build-essential \
        unzip \
        wget \
        && \
    rm -rf /var/lib/apt/lists/*

# Install Bazel 3.7.2
ENV BAZELISK_VERSION=v1.20.0
ENV BAZELISK_URL=https://github.com/bazelbuild/bazelisk/releases/download/${BAZELISK_VERSION}/bazelisk-linux-arm64
ENV BAZEL_VERSION=3.7.2

RUN curl -L $BAZELISK_URL -o /usr/local/bin/bazelisk && \
    chmod +x /usr/local/bin/bazelisk && \
    ln -s /usr/local/bin/bazelisk /usr/local/bin/bazel

# Confirm Bazel installation
RUN bazelisk version
RUN bazel version

# Print Clang version
RUN clang --version

# Download the LightGBM shared library (.so file) from GitHub releases
RUN wget -O /usr/local/lib/lib_lightgbm.so https://github.com/microsoft/LightGBM/releases/download/v4.2.0/lib_lightgbm.so

# Download the Catboost shared library (.so file) from GitHub releases
RUN wget -O /usr/local/lib/libcatboostmodel.so https://github.com/catboost/catboost/releases/download/v1.2.3/libcatboostmodel.so

# Download libtorch
RUN wget -O /tmp/libtorch.zip https://download.pytorch.org/libtorch/cpu/libtorch-cxx11-abi-shared-with-deps-2.2.0%2Bcpu.zip && \
    unzip /tmp/libtorch.zip -d /usr/local/lib/ && \
    rm /tmp/libtorch.zip

# Set the environment variable to include the directory where the shared library is located
ENV LIGHTGBM_LIB_DIR=/usr/local/lib
ENV LIBTORCH=/usr/local/lib/libtorch
ENV LD_LIBRARY_PATH=/usr/local/lib/libtorch/lib:/usr/local/lib
# Set entry point to bash
ENTRYPOINT ["/bin/bash"]